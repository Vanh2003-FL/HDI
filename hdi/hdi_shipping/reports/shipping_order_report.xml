<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Shipping Order Report Definition -->
  <record id="action_report_shipping_order" model="ir.actions.report">
    <field name="name">Phiếu gửi hàng</field>
    <field name="model">shipping.order</field>
    <field name="report_type">qweb-pdf</field>
    <field name="report_name">hdi_shipping.report_shipping_order_document</field>
    <field name="report_file">hdi_shipping.report_shipping_order_document</field>
    <field name="binding_model_id" ref="model_shipping_order"/>
    <field name="binding_type">report</field>
    <field name="print_report_name">'Phiếu gửi - %s' % (object.order_number)</field>
  </record>

  <!-- Report Template -->
  <template id="report_shipping_order_document">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">
        <t t-call="web.external_layout">
          <div class="page">
            <h2 class="text-center">PHIẾU GỬI HÀNG</h2>
            
            <!-- Order Header -->
            <div class="row mt-4">
              <div class="col-6">
                <strong>Mã đơn hàng:</strong> <span t-field="o.order_number"/>
              </div>
              <div class="col-6 text-end">
                <strong>Ngày tạo:</strong> <span t-field="o.created_date" t-options='{"widget": "datetime", "format": "dd/MM/yyyy HH:mm"}'/>
              </div>
            </div>
            
            <div class="row mt-2">
              <div class="col-6">
                <strong>Trạng thái:</strong> 
                <t t-if="o.state == 'draft'">
                  <span class="badge bg-info">Đơn nháp</span>
                </t>
                <t t-elif="o.state == 'waiting_pickup'">
                  <span class="badge bg-primary">Chờ lấy hàng</span>
                </t>
                <t t-elif="o.state == 'in_transit'">
                  <span class="badge bg-warning">Đang vận chuyển</span>
                </t>
                <t t-elif="o.state == 'delivered'">
                  <span class="badge bg-success">Đã giao</span>
                </t>
                <t t-elif="o.state == 'pending_return_approval'">
                  <span class="badge bg-danger">Chờ duyệt hoàn</span>
                </t>
                <t t-elif="o.state == 'returned'">
                  <span class="badge bg-secondary">Đã hoàn</span>
                </t>
                <t t-elif="o.state == 'cancelled'">
                  <span class="badge bg-dark">Đã hủy</span>
                </t>
              </div>
              <div class="col-6 text-end">
                <strong>Dịch vụ:</strong> <span t-field="o.shipping_service_id.name"/>
              </div>
            </div>

            <!-- Sender & Receiver Info -->
            <div class="row mt-4">
              <div class="col-6">
                <h5><strong>Thông tin người gửi</strong></h5>
                <div><strong>Tên:</strong> <span t-field="o.sender_name"/></div>
                <div><strong>Điện thoại:</strong> <span t-field="o.sender_phone"/></div>
                <div><strong>Địa chỉ:</strong> <span t-field="o.sender_address_id.full_address"/></div>
              </div>
              <div class="col-6">
                <h5><strong>Thông tin người nhận</strong></h5>
                <div><strong>Tên:</strong> <span t-field="o.receiver_name"/></div>
                <div><strong>Điện thoại:</strong> <span t-field="o.receiver_phone"/></div>
                <div>
                  <strong>Địa chỉ:</strong> 
                  <span t-field="o.receiver_street"/>, 
                  <span t-field="o.receiver_city"/>
                  <t t-if="o.receiver_state">, <span t-field="o.receiver_state"/></t>
                  <t t-if="o.receiver_zip"> - <span t-field="o.receiver_zip"/></t>
                </div>
                <div t-if="o.time_slot">
                  <strong>Khung giờ nhận:</strong> 
                  <t t-if="o.time_slot == 'morning'">6h - 12h</t>
                  <t t-elif="o.time_slot == 'afternoon'">12h - 18h</t>
                  <t t-elif="o.time_slot == 'evening'">18h - 21h</t>
                  <t t-else>Cả ngày</t>
                </div>
              </div>
            </div>

            <!-- Shipment Items -->
            <div class="row mt-4">
              <div class="col-12">
                <h5><strong>Thông tin hàng hóa</strong></h5>
                <table class="table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th>STT</th>
                      <th>Tên hàng hóa</th>
                      <th>Loại hàng</th>
                      <th class="text-center">Số lượng</th>
                      <th class="text-end">Trọng lượng (kg)</th>
                      <th class="text-end">Giá trị (VNĐ)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <t t-set="index" t-value="0"/>
                    <tr t-foreach="o.shipment_item_ids" t-as="item">
                      <t t-set="index" t-value="index + 1"/>
                      <td><t t-esc="index"/></td>
                      <td><span t-field="item.name"/></td>
                      <td><span t-field="item.category"/></td>
                      <td class="text-center"><span t-field="item.quantity"/></td>
                      <td class="text-end"><span t-field="item.weight"/></td>
                      <td class="text-end"><span t-field="item.value" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                    </tr>
                    <tr>
                      <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                      <td class="text-center"><strong><span t-esc="len(o.shipment_item_ids)"/> mặt hàng</strong></td>
                      <td class="text-end"><strong><span t-field="o.total_weight"/></strong></td>
                      <td class="text-end"><strong><span t-field="o.total_value" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></strong></td>
                    </tr>
                  </tbody>
                </table>
                
                <div t-if="o.reference_code" class="mt-2">
                  <strong>Mã tham chiếu:</strong> <span t-field="o.reference_code"/>
                </div>
                <div t-if="o.note" class="mt-2">
                  <strong>Ghi chú hàng hóa:</strong> <span t-field="o.note"/>
                </div>
              </div>
            </div>

            <!-- Fee Information -->
            <div class="row mt-4">
              <div class="col-12">
                <h5><strong>Thông tin cước phí</strong></h5>
                <table class="table table-sm">
                  <tr>
                    <td><strong>Cước phí vận chuyển:</strong></td>
                    <td class="text-end"><span t-field="o.shipping_cost" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                  </tr>
                  <tr t-if="o.cod_amount > 0">
                    <td><strong>Tiền thu hộ (COD):</strong></td>
                    <td class="text-end"><span t-field="o.cod_amount" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></td>
                  </tr>
                  <tr>
                    <td><strong>Người thanh toán cước:</strong></td>
                    <td class="text-end">
                      <t t-if="o.is_receiver_pay">Người nhận</t>
                      <t t-else>Người gửi</t>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Tổng cước phí:</strong></td>
                    <td class="text-end"><strong><span t-field="o.total_fee" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/></strong></td>
                  </tr>
                </table>
                
                <div t-if="o.pickup_at_office" class="alert alert-info mt-2">
                  <i class="fa fa-info-circle"/> Khách hàng sẽ tới văn phòng để gửi hàng
                </div>
                
                <div t-if="o.order_notes" class="mt-2">
                  <strong>Ghi chú đơn hàng:</strong><br/>
                  <span t-field="o.order_notes"/>
                </div>
              </div>
            </div>

            <!-- Signature Area -->
            <div class="row mt-5">
              <div class="col-6 text-center">
                <strong>Người gửi</strong><br/>
                <em>(Ký và ghi rõ họ tên)</em>
                <div style="height: 80px;"></div>
              </div>
              <div class="col-6 text-center">
                <strong>Người nhận</strong><br/>
                <em>(Ký và ghi rõ họ tên)</em>
                <div style="height: 80px;"></div>
              </div>
            </div>

            <!-- Footer Note -->
            <div class="row mt-3">
              <div class="col-12">
                <p class="text-muted small">
                  <em>
                    * Vui lòng kiểm tra kỹ hàng hóa trước khi ký nhận.<br/>
                    * Mọi thắc mắc xin liên hệ hotline: 1900-xxxx<br/>
                    * Phiếu này được in từ hệ thống HDI Shipping
                  </em>
                </p>
              </div>
            </div>

          </div>
        </t>
      </t>
    </t>
  </template>
</odoo>
