<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Shipping Order Search/Filter View -->
  <record id="view_shipping_order_search" model="ir.ui.view">
    <field name="name">shipping.order.search</field>
    <field name="model">shipping.order</field>
    <field name="arch" type="xml">
      <search>
        <!-- Search fields -->
        <field name="order_number" string="Mã đơn hàng"/>
        <field name="receiver_name" string="Tên người nhận"/>
        <field name="receiver_phone" string="SĐT người nhận" 
               filter_domain="['|', ('receiver_phone', 'ilike', self), ('receiver_phone', '=', self)]"/>
        <field name="sender_address_id" string="Địa chỉ gửi"/>
        <field name="shipping_service_id" string="Dịch vụ"/>

        <!-- Filters -->
        <filter string="Đơn nháp" name="filter_draft" domain="[('state', '=', 'draft')]"/>
        <filter string="Chờ lấy hàng" name="filter_waiting_pickup" domain="[('state', '=', 'waiting_pickup')]"/>
        <filter string="Đang vận chuyển" name="filter_in_transit" domain="[('state', '=', 'in_transit')]"/>
        <filter string="Chờ duyệt hoàn" name="filter_pending_return" domain="[('state', '=', 'pending_return_approval')]"/>
        <filter string="Đã giao" name="filter_delivered" domain="[('state', '=', 'delivered')]"/>
        <filter string="Đã hoàn" name="filter_returned" domain="[('state', '=', 'returned')]"/>
        <filter string="Đã hủy" name="filter_cancelled" domain="[('state', '=', 'cancelled')]"/>
        
        <separator/>
        
        <!-- Date filters -->
        <filter string="Hôm nay" name="filter_today" 
                domain="[('created_date', '&gt;=', datetime.datetime.now().replace(hour=0, minute=0, second=0)),
                         ('created_date', '&lt;=', datetime.datetime.now().replace(hour=23, minute=59, second=59))]"/>
        <filter string="Tuần này" name="filter_this_week" 
                domain="[('created_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                         ('created_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
        <filter string="Tháng này" name="filter_this_month" 
                domain="[('created_date', '&gt;=', datetime.datetime.now().replace(day=1, hour=0, minute=0, second=0))]"/>
        
        <separator/>
        
        <!-- Group by -->
        <group expand="0" string="Nhóm theo">
          <filter string="Trạng thái" name="group_state" context="{'group_by': 'state'}"/>
          <filter string="Địa chỉ gửi" name="group_sender_address" context="{'group_by': 'sender_address_id'}"/>
          <filter string="Dịch vụ" name="group_service" context="{'group_by': 'shipping_service_id'}"/>
          <filter string="Ngày tạo" name="group_created_date" context="{'group_by': 'created_date:day'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- Shipping Order List View (Enhanced) -->
  <record id="view_shipping_order_list" model="ir.ui.view">
    <field name="name">shipping.order.list</field>
    <field name="model">shipping.order</field>
    <field name="arch" type="xml">
      <list multi_edit="1" decoration-info="state == 'draft'" 
            decoration-primary="state == 'waiting_pickup'"
            decoration-warning="state == 'pending_return_approval'"
            decoration-success="state == 'delivered'"
            decoration-muted="state in ['cancelled', 'returned']">
        <header>
          <button name="%(action_shipping_order_print_wizard)d" 
                  string="In đơn đã chọn" 
                  type="action" 
                  class="btn-primary"/>
        </header>
        
        <field name="order_number" string="Mã đơn"/>
        <field name="receiver_name" string="Người nhận"/>
        <field name="receiver_phone" string="SĐT nhận"/>
        <field name="receiver_city" string="Địa chỉ nhận"/>
        <field name="created_date" string="Ngày tạo"/>
        <field name="shipping_service_id" string="Dịch vụ"/>
        <field name="cod_amount" string="COD" optional="show"/>
        <field name="is_receiver_pay" string="Người thanh toán" widget="badge" 
               decoration-success="is_receiver_pay == True"
               decoration-info="is_receiver_pay == False" optional="show"/>
        <field name="state" string="Trạng thái" widget="badge" 
               decoration-info="state == 'draft'"
               decoration-primary="state == 'waiting_pickup'"
               decoration-warning="state == 'pending_return_approval'"
               decoration-success="state == 'delivered'"
               decoration-muted="state in ['cancelled', 'returned']"/>
        <field name="total_fee" string="Cước phí" optional="show"/>
      </list>
    </field>
  </record>

  <!-- Shipping Order Form View (Enhanced) -->
  <record id="view_shipping_order_form" model="ir.ui.view">
    <field name="name">shipping.order.form</field>
    <field name="model">shipping.order</field>
    <field name="arch" type="xml">
      <form>
        <header>
          <button name="action_submit" string="Gửi đơn" type="object" class="oe_highlight" invisible="state != 'draft'"/>
          <button name="action_cancel" string="Hủy" type="object" invisible="state not in ['draft', 'submitted']"/>
          <field name="state" widget="statusbar"/>
        </header>
        <sheet>
          <div class="oe_title">
            <h1><field name="order_number" readonly="1"/></h1>
          </div>

          <!-- Sender Information -->
          <group string="Thông tin người gửi" name="sender_group">
            <field name="sender_address_id" widget="many2one" options="{'no_create': True}"/>
            <field name="sender_name" readonly="1"/>
            <field name="sender_phone" readonly="1"/>
          </group>

          <!-- Receiver Information -->
          <group string="Thông tin người nhận" name="receiver_group">
            <field name="receiver_name"/>
            <field name="receiver_phone"/>
            <field name="receiver_street"/>
            <field name="receiver_city"/>
            <field name="receiver_state"/>
            <field name="receiver_zip"/>
            <field name="time_slot"/>
          </group>

          <!-- Shipment Items -->
          <group string="Thông tin hàng hóa" name="shipment_group">
            <field name="allow_view"/>
            <field name="reference_code"/>
            <field name="note" placeholder="Ghi chú về hàng hóa"/>
            <field name="total_weight" readonly="1"/>
            <field name="total_value" readonly="1"/>
          </group>

          <!-- Shipment Items Table -->
          <field name="shipment_item_ids">
            <list editable="bottom">
              <field name="name" required="1"/>
              <field name="category"/>
              <field name="quantity"/>
              <field name="weight" required="1"/>
              <field name="value"/>
            </list>
          </field>

          <!-- Shipping Service & Cost -->
          <group string="Dịch vụ vận chuyển" name="service_group">
            <field name="shipping_service_id" widget="many2one" options="{'no_create': True}"/>
            <field name="shipping_cost" readonly="1"/>
          </group>

          <!-- Fee Information -->
          <group string="Thông tin cước phí" name="fee_group">
            <field name="is_receiver_pay"/>
            <field name="cod_amount" invisible="not is_receiver_pay"/>
            <field name="total_fee" readonly="1"/>
            <field name="pickup_at_office"/>
          </group>

          <!-- Order Notes -->
          <group string="Ghi chú đơn hàng" name="notes_group">
            <field name="order_notes" nolabel="1" colspan="4"/>
          </group>
        </sheet>
      </form>
    </field>
  </record>

  <!-- Shipping Order Action -->
  <record id="action_shipping_order" model="ir.actions.act_window">
    <field name="name">Tạo đơn hàng</field>
    <field name="res_model">shipping.order</field>
    <field name="view_mode">list,form</field>
    <field name="help" type="html">
      <p class="oe_view_nocontent_create">Tạo đơn hàng vận chuyển mới</p>
    </field>
  </record>
</odoo>
