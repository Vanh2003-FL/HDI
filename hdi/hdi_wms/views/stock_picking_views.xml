<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_picking_form_wms" model="ir.ui.view">
        <field name="name">stock.picking.form.wms</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">

            <!-- Add WMS State after state -->
            <field name="state" position="after">
                <field name="wms_state" widget="badge"
                       decoration-info="wms_state in ('batch_creation', 'picking_ready')"
                       decoration-warning="wms_state in ('putaway_pending', 'picking_progress')"
                       decoration-success="wms_state == 'wms_done'"
                       groups="hdi_wms.group_wms_user"/>
            </field>

            <!-- Add WMS buttons in header -->
            <button name="button_validate" position="before">
                <!-- INBOUND BUTTONS -->
                <button name="action_confirm_handover" type="object" string="X√°c nh·∫≠n b√†n giao"
                        invisible="production_handover_signed_by or state not in ('assigned', 'confirmed') or picking_type_code != 'incoming'"
                        class="btn-warning"
                        groups="hdi_wms.group_wms_user"/>
                <button name="action_create_batch" type="object" string="T·∫°o L√¥ h√†ng"
                        invisible="state != 'assigned' or not use_batch_management or picking_type_code != 'incoming'"
                        class="btn-primary"
                        groups="hdi_wms.group_wms_user"/>
                <button name="action_suggest_putaway_all" type="object" string="G·ª£i √Ω V·ªã tr√≠"
                        invisible="wms_state not in ('batch_creation', 'putaway_pending') or picking_type_code != 'incoming'"
                        class="btn-secondary"
                        groups="hdi_wms.group_wms_user"/>
                
                <!-- OUTBOUND BUTTONS -->
                <button name="action_generate_pick_suggestions" type="object" string="G·ª£i √Ω L·∫•y h√†ng (FIFO)"
                        invisible="state != 'assigned' or picking_type_code != 'outgoing'"
                        class="btn-primary"
                        groups="hdi_wms.group_wms_user"
                        help="T·∫°o g·ª£i √Ω v·ªã tr√≠ v√† batch l·∫•y h√†ng theo chi·∫øn l∆∞·ª£c FIFO/FEFO"/>
                <button name="action_create_pick_tasks" type="object" string="T·∫°o C√¥ng vi·ªác L·∫•y h√†ng"
                        invisible="not pick_suggestion_ids or picking_type_code != 'outgoing'"
                        class="btn-success"
                        groups="hdi_wms.group_wms_user"
                        help="T·∫°o c√¥ng vi·ªác cho nh√¢n vi√™n kho t·ª´ g·ª£i √Ω"/>
                
                <!-- COMMON BUTTONS -->
                <button name="action_open_scanner" type="object" string="Qu√©t M√£ v·∫°ch"
                        invisible="state not in ('assigned', 'confirmed')"
                        class="btn-info"
                        groups="hdi_wms.group_wms_scanner"/>
            </button>

            <xpath expr="//form/sheet/notebook" position="before">
                <!-- INBOUND Configuration -->
                <group string="C·∫•u h√¨nh Nh·∫≠p kho" groups="hdi_wms.group_wms_user"
                       invisible="picking_type_code != 'incoming'">
                    <group>
                        <field name="use_batch_management" string="‚òë Qu·∫£n l√Ω theo L√¥ h√†ng/Pallet"/>
                        <field name="scan_detail_level" invisible="not use_batch_management" string="Chi ti·∫øt qu√©t m√£"/>
                    </group>
                    <group>
                        <field name="production_handover_signed_by" readonly="1" invisible="not production_handover_signed_by" string="Ng∆∞·ªùi b√†n giao"/>
                        <field name="production_handover_date" readonly="1" invisible="not production_handover_date" string="Th·ªùi gian b√†n giao"/>
                    </group>
                </group>

                <!-- OUTBOUND Configuration -->
                <group string="C·∫•u h√¨nh Xu·∫•t kho (FIFO/FEFO)" groups="hdi_wms.group_wms_user"
                       invisible="picking_type_code != 'outgoing'">
                    <group>
                        <field name="pick_strategy" string="Chi·∫øn l∆∞·ª£c L·∫•y h√†ng" widget="radio"/>
                        <field name="wms_state" widget="badge" readonly="1"/>
                    </group>
                    <group>
                        <field name="pick_suggestion_count" string="S·ªë g·ª£i √Ω" readonly="1"/>
                        <field name="pick_task_count" string="S·ªë c√¥ng vi·ªác" readonly="1"/>
                    </group>
                </group>

                <!-- Hidden fields -->
                <field name="picking_type_code" invisible="1"/>
                <field name="require_putaway_suggestion" invisible="1"/>
                <field name="batch_count" invisible="1"/>
            </xpath>

            <!-- Add Batch tab -->
            <notebook position="inside">
                <!-- INBOUND TABS -->
                <page string="üì¶ L√¥ h√†ng / Batch" name="wms_batches"
                      invisible="picking_type_code != 'incoming' or not use_batch_management"
                      groups="hdi_wms.group_wms_user">
                    <div class="alert alert-info" role="alert">
                        <strong>üì¶ Qu·∫£n l√Ω L√¥ h√†ng (Batch/Pallet/LPN):</strong>
                        <ul>
                            <li><strong>T·∫°o l√¥ m·ªõi</strong>: Click button "T·∫°o L√¥" b√™n d∆∞·ªõi</li>
                            <li><strong>Qu√©t barcode</strong>: S·ª≠ d·ª•ng ch·∫ø ƒë·ªô qu√©t ƒë·ªÉ nh·∫≠n h√†ng nhanh</li>
                            <li><strong>G·ª£i √Ω v·ªã tr√≠</strong>: Sau khi t·∫°o l√¥, h·ªá th·ªëng s·∫Ω g·ª£i √Ω v·ªã tr√≠ ƒë·∫∑t h√†ng</li>
                        </ul>
                    </div>
                    <group>
                        <group string="üéØ C·∫•u h√¨nh Qu√©t">
                            <field name="scan_mode" widget="radio" options="{'horizontal': true}" string="Ch·∫ø ƒë·ªô qu√©t"/>
                            <field name="last_scanned_barcode" readonly="1" placeholder="Ch∆∞a qu√©t m√£ n√†o" string="M√£ v·ª´a qu√©t"/>
                        </group>
                        <group string="üìä Tr·∫°ng th√°i WMS">
                            <field name="wms_state" widget="badge"/>
                            <field name="batch_count" string="S·ªë l√¥ h√†ng"/>
                            <button name="action_view_batches" type="object"
                                    string="‚ûú Xem t·∫•t c·∫£ L√¥ h√†ng"
                                    class="oe_link"
                                    invisible="not batch_count"/>
                        </group>
                    </group>
                    <group>
                        <button name="action_create_batch" type="object" string="‚ûï T·∫°o L√¥ h√†ng m·ªõi"
                                class="btn-primary oe_highlight"
                                invisible="picking_type_code != 'incoming'"
                                help="T·∫°o l√¥ h√†ng/pallet/LPN m·ªõi cho phi·∫øu nh·∫≠p n√†y"/>
                    </group>
                    <separator string="üìã Danh s√°ch l√¥ h√†ng trong phi·∫øu nh·∫≠p n√†y"/>
                    <field name="batch_ids" nolabel="1" context="{'form_view_ref': 'hdi_wms.view_batch_form', 'tree_view_ref': 'hdi_wms.view_batch_tree'}"/>
                </page>

                <!-- OUTBOUND TABS -->
                <page string="üìç G·ª£i √Ω L·∫•y h√†ng (FIFO/FEFO)" name="wms_pick_suggestions"
                      invisible="picking_type_code != 'outgoing'"
                      groups="hdi_wms.group_wms_user">
                    <div class="alert alert-info" role="alert">
                        <strong>üéØ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong>
                        <ol>
                            <li><strong>Ch·ªçn chi·∫øn l∆∞·ª£c</strong>: FIFO (h√†ng c≈© l·∫•y tr∆∞·ªõc) ho·∫∑c FEFO (h√†ng g·∫ßn h·∫øt h·∫°n l·∫•y tr∆∞·ªõc)</li>
                            <li><strong>Click "üîÑ T·∫°o G·ª£i √Ω"</strong>: H·ªá th·ªëng t·ª± ƒë·ªông t√≠nh to√°n v·ªã tr√≠ v√† batch l·∫•y h√†ng</li>
                            <li><strong>Xem danh s√°ch g·ª£i √Ω</strong>: Theo th·ª© t·ª± ∆∞u ti√™n l·∫•y h√†ng</li>
                            <li><strong>T·∫°o c√¥ng vi·ªác</strong>: Chuy·ªÉn sang tab "C√¥ng vi·ªác" ƒë·ªÉ g√°n nh√¢n vi√™n kho</li>
                        </ol>
                    </div>
                    <group>
                        <group string="‚öôÔ∏è Chi·∫øn l∆∞·ª£c">
                            <field name="pick_strategy" widget="radio"/>
                            <button name="action_generate_pick_suggestions" type="object"
                                    string="üîÑ T·∫°o G·ª£i √Ω"
                                    class="btn-primary"
                                    help="H·ªá th·ªëng t·ª± ƒë·ªông g·ª£i √Ω v·ªã tr√≠ v√† batch l·∫•y h√†ng theo FIFO/FEFO"/>
                        </group>
                        <group string="üìä Th·ªëng k√™">
                            <field name="pick_suggestion_count" string="S·ªë g·ª£i √Ω"/>
                            <field name="wms_state" widget="badge"/>
                            <button name="action_view_pick_suggestions" type="object"
                                    string="‚ûú Xem t·∫•t c·∫£ G·ª£i √Ω"
                                    class="oe_link"
                                    invisible="not pick_suggestion_count"/>
                        </group>
                    </group>
                    <separator string="üìã Danh s√°ch g·ª£i √Ω (theo th·ª© t·ª± l·∫•y h√†ng)"/>
                    <field name="pick_suggestion_ids" nolabel="1">
                        <list>
                            <field name="product_id"/>
                            <field name="location_id"/>
                            <field name="coordinate_display" string="T·ªça ƒë·ªô"/>
                            <field name="batch_id"/>
                            <field name="quantity_to_pick" string="S·ªë l∆∞·ª£ng l·∫•y" sum="T·ªïng"/>
                            <field name="inbound_date" string="Ng√†y nh·∫≠p"/>
                            <field name="pick_reason" widget="text" string="L√Ω do ch·ªçn"/>
                            <field name="state" widget="badge"/>
                        </list>
                    </field>
                </page>

                <page string="üë∑ C√¥ng vi·ªác L·∫•y h√†ng" name="wms_pick_tasks"
                      invisible="picking_type_code != 'outgoing'"
                      groups="hdi_wms.group_wms_user">
                    <div class="alert alert-success" role="alert">
                        <strong>‚úÖ Quy tr√¨nh th·ª±c hi·ªán:</strong>
                        <ol>
                            <li><strong>T·∫°o c√¥ng vi·ªác</strong> t·ª´ danh s√°ch g·ª£i √Ω (tab tr∆∞·ªõc)</li>
                            <li><strong>G√°n nh√¢n vi√™n kho</strong> cho t·ª´ng c√¥ng vi·ªác</li>
                            <li><strong>Nh√¢n vi√™n s·ª≠ d·ª•ng mobile/scanner</strong> ƒë·ªÉ qu√©t barcode v√† x√°c nh·∫≠n l·∫•y h√†ng</li>
                            <li><strong>H·ªá th·ªëng t·ª± ƒë·ªông c·∫≠p nh·∫≠t</strong> s·ªë l∆∞·ª£ng ƒë√£ l·∫•y v√† tr·∫°ng th√°i</li>
                        </ol>
                    </div>
                    <group>
                        <group>
                            <button name="action_create_pick_tasks" type="object"
                                    string="‚ûï T·∫°o C√¥ng vi·ªác t·ª´ G·ª£i √Ω"
                                    class="btn-success oe_highlight"
                                    invisible="not pick_suggestion_ids"
                                    help="T·∫°o c√¥ng vi·ªác cho nh√¢n vi√™n kho t·ª´ danh s√°ch g·ª£i √Ω"/>
                        </group>
                        <group string="üìä Th·ªëng k√™">
                            <field name="pick_task_count" string="S·ªë c√¥ng vi·ªác"/>
                            <field name="wms_state" widget="badge"/>
                            <button name="action_view_pick_tasks" type="object"
                                    string="‚ûú Xem t·∫•t c·∫£ C√¥ng vi·ªác"
                                    class="oe_link"
                                    invisible="not pick_task_count"/>
                        </group>
                    </group>
                    <separator string="üìù Danh s√°ch c√¥ng vi·ªác cho nh√¢n vi√™n kho"/>
                    <field name="pick_task_ids" nolabel="1">
                        <list>
                            <field name="product_id"/>
                            <field name="location_id"/>
                            <field name="coordinate_display" string="T·ªça ƒë·ªô"/>
                            <field name="batch_id"/>
                            <field name="planned_qty" string="C·∫ßn l·∫•y"/>
                            <field name="picked_qty" string="ƒê√£ l·∫•y"/>
                            <field name="assigned_user_id" string="Nh√¢n vi√™n"/>
                            <field name="state" widget="badge"/>
                        </list>
                    </field>
                </page>

                <!-- COMMON TABS -->
                <page string="H√†ng l·∫ª" name="wms_loose_items"
                      invisible="not use_batch_management"
                      groups="hdi_wms.group_wms_user">
                    <field name="loose_line_ids" widget="one2many" string="Danh s√°ch h√†ng l·∫ª"/>
                </page>
            </notebook>

        </field>
    </record>

    <!-- Tree view extension -->
    <record id="view_picking_tree_wms" model="ir.ui.view">
        <field name="name">stock.picking.tree.wms</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.vpicktree"/>
        <field name="arch" type="xml">
            <field name="state" position="after">
                <field name="wms_state" optional="show" widget="badge"
                       groups="hdi_wms.group_wms_user"/>
                <field name="batch_count" optional="show"
                       groups="hdi_wms.group_wms_user"/>
            </field>
        </field>
    </record>

    <!-- Scanner view (mobile-friendly) -->
    <record id="view_picking_form_scanner" model="ir.ui.view">
        <field name="name">stock.picking.form.scanner</field>
        <field name="model">stock.picking</field>
        <field name="priority">999</field>
        <field name="arch" type="xml">
            <form string="Scanner Mode">
                <header>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_batches" type="object"
                                class="oe_stat_button" icon="fa-th">
                            <field name="batch_count" widget="statinfo" string="Batches"/>
                        </button>
                    </div>
                    <group>
                        <group>
                            <field name="name" readonly="1"/>
                            <field name="partner_id" readonly="1"/>
                            <field name="picking_type_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="location_id" readonly="1"/>
                            <field name="location_dest_id" readonly="1"/>
                            <field name="wms_state" widget="badge"/>
                        </group>
                    </group>
                    <group string="Scanner">
                        <field name="scan_mode" widget="radio"/>
                        <field name="last_scanned_barcode" readonly="1"
                               class="text-success"
                               style="font-size: 20px; font-weight: bold;"/>
                    </group>
                    <notebook>
                        <page string="Batches">
                            <field name="batch_ids" widget="one2many"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

</odoo>
