<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="business_plan_form" model="ir.ui.view">
        <field name="name">business.plan.form</field>
        <field name="model">business.plan</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="is_next_user_to_approve" invisible="1" />
                    <field name="show_button_request" invisible="1" />
                    <field name="show_button_cancel" invisible="1" />
                    <field name="show_btn_draft" invisible="1" />
                    <button name="button_request" class="btn btn-primary" attrs="{'invisible': [('show_button_request', '=', False)]}" string="Gửi duyệt" type="object" />
<!--                    <button name="button_draft" attrs="{'invisible': [('state', '!=', 'waiting')]}" string="Thiết lập về nháp" type="object" />-->
                    <button name="button_draft" attrs="{'invisible': ['|', ('state', '!=', 'waiting'), ('show_btn_draft', '=', False)]}" string="Thiết lập về nháp" type="object" />
                    <button name="button_confirm" class="btn btn-primary" attrs="{'invisible': ['|', ('state', '!=', 'waiting'), ('is_next_user_to_approve', '=', False)]}" string="Duyệt" type="object" />
                    <button name="button_deny" attrs="{'invisible': ['|', ('state', '!=', 'waiting'), ('is_next_user_to_approve', '=', False)]}" string="Từ chối" type="object" />
                    <button name="button_cancel" attrs="{'invisible': [('show_button_cancel', '=', False)]}" string="Hủy" type="object" />
                    <field name="state" widget="statusbar" />
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>Kế hoạch công tác</h1>
                    </div>
                    <group>
                        <group>
                            <field name="is_sale" attrs="{'readonly': [('state', '!=', 'new')]}" />
                            <field name="project_id" attrs="{'readonly': [('state', '!=', 'new')]}" />
                            <field name="origin" attrs="{'readonly': [('state', '!=', 'new')]}" />
                            <field name="location" attrs="{'readonly': [('state', '!=', 'new')]}" />
                            <field name="responsible_id" attrs="{'readonly': [('state', '!=', 'new')]}"  context="{'view_all_hr_employee': True}"/>
                            <label for="estimate_time_start" string="Lịch dự kiến" attrs="{'readonly': [('state', '!=', 'new')]}" />
                            <div class="o_row">
                                <field name="estimate_time_start" attrs="{'readonly': [('state', '!=', 'new')]}" class="oe_inline" nolabel="1"
                                    widget="daterange" options="{'related_end_date': 'estimate_time_end'}"/>
                                <span class="oe_inline">
                                    <i class="fa fa-arrow-right" role="img" aria-label="Đến" title="Đến"/>
                                </span>
                                <field attrs="{'readonly': [('state', '!=', 'new')]}" name="estimate_time_end" class="oe_inline"
                                    widget="daterange" options="{'related_start_date': 'estimate_time_start'}"/>
                            </div>
                        </group>
                        <group>
                            <field name="code" readonly="1" />
                        </group>
                    </group>
                    <notebook>
                        <page string="Danh sách nhân sự công tác" name="employees">
                            <field name="partner_ids" nolabel="1" attrs="{'readonly': [('state', '!=', 'new')]}">
                                <list editable="bottom">
                                    <field name="department_id" />
                                    <field name="employee_code" />
                                    <field name="employee_id" context="{'view_all_employee': True}"/>
                                    <field name="position" />
                                    <field name="support_employee_id" context="{'view_all_employee': True}"/>
                                </list>
                            </field>
                        </page>
                        <page string="Chi phí ước tính" name="estimate_fees">
                            <field name="estimate_ids" nolabel="1" attrs="{'readonly': [('state', '!=', 'new')]}">
                                <list editable="bottom">
                                    <field name="sequence" />
                                    <field name="category" />
                                    <field name="amount" />
                                    <field name="norms_amount" />
                                    <field name="total_amount" sum="Tổng" />
                                    <field name="note" />
                                </list>
                            </field>
                        </page>
                        <page string="Thông tin phê duyệt" name="approval_info">
                            <field name="approver_ids" mode="tree,kanban">
                                <list editable="bottom" decoration-success="status=='approved'" decoration-warning="status=='pending'" decoration-danger="status=='refused'">
                                    <field name="existing_request_user_ids" invisible="1"/>
                                    <field name="can_edit" invisible="1"/>
                                    <field name="user_id" string="Người duyệt" attrs="{'readonly':[('status','!=','new')]}"/>
                                    <field name="role_selection" string="Vai trò" />
                                    <field name="status" string="Trạng thái"/>
                                    <field name="company_id" invisible="1"/>
                                </list>
                                <kanban class="o_kanban_mobile">
                                    <field name="company_id" invisible="1"/>
                                    <field name="user_id"/>
                                    <field name="status"/>
                                    <templates>
                                        <t t-name="card">
                                            <div class="oe_kanban_card oe_kanban_global_click">
                                                <div class="o_kanban_content">
                                                    <t t-esc="record.user_id.value"/>
                                                    <t t-if="record.status.raw_value">
                                                        <t t-set="classname" t-value="{'approved': 'badge-success', 'pending': 'badge-warning', 'refused': 'badge-danger'}[record.status.raw_value] || 'badge-light'"/>
                                                        <span t-esc="record.status.raw_value" t-attf-class="float-right badge-pill {{ classname }}"/>
                                                    </t>
                                                </div>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="business_plan_tree" model="ir.ui.view">
        <field name="name">business.plan.tree</field>
        <field name="model">business.plan</field>
        <field name="arch" type="xml">
            <list>
                <field name="code" />
                <field name="is_sale" />
                <field name="project_id" />
                <field name="responsible_id" />
                <field name="origin" />
                <field name="location" string="Địa điểm đến" />
                <field name="estimate_time_start" string="Thời gian đi" />
                <field name="estimate_time_end" string="Thời gian đến" />
                <field name="state" />
            </list>
        </field>
    </record>

    <record id="business_plan_search" model="ir.ui.view">
        <field name="name">business.plan.search</field>
        <field name="model">business.plan</field>
        <field name="arch" type="xml">
            <search>
                <field name="code" />
                <field name="project_id" />
                <field name="responsible_id" />
                <field name="origin" />
                <field name="location" string="Địa điểm đến" />
                <filter name="today" string="Kế hoạch công tác hôm nay" domain="['|', ('estimate_time_start', '=', context_today().strftime('%Y-%m-%d')), ('estimate_time_end', '=', context_today().strftime('%Y-%m-%d'))]" />
                <filter string="Kế hoạch công tác ngày mai" name="tomorrow"
                        domain="['|', ('estimate_time_start', '=', (context_today() + relativedelta(days=1)).strftime('%Y-%m-%d')), ('estimate_time_end', '=', (context_today() + relativedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Kế hoạch công tác tuần tới" name="next_week"
                    domain="[
                    '|', '&amp;',
                    ('estimate_time_start', '&gt;', (context_today() + relativedelta(weekday=0) + relativedelta(days=-1)).strftime('%Y-%m-%d')), 
                    ('estimate_time_start', '&lt;', (context_today() + relativedelta(weekday=0) + relativedelta(days=7)).strftime('%Y-%m-%d')),
                    '&amp;',
                    ('estimate_time_end', '&gt;', (context_today() + relativedelta(weekday=0) + relativedelta(days=-1)).strftime('%Y-%m-%d')), 
                    ('estimate_time_end', '&lt;', (context_today() + relativedelta(weekday=0) + relativedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter name="need_approval_filter" string="Cần duyệt"
                        domain="[('state', '=', 'waiting'), ('approver_ids.user_id', '=', uid)]"/>
            </search>
        </field>
    </record>

    <record id="action_open_business_plan" model="ir.actions.act_window">
        <field name="name">Kế hoạch công tác</field>
        <field name="res_model">business.plan</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'view_all_hr_employee': True}</field>
    </record>

    <menuitem id="business_request_menu" name="Kế hoạch công tác" parent="ngs_approval_request_root_menu" action="action_open_business_plan" sequence="20"/>

</odoo>